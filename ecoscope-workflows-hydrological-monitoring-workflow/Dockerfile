# AUTOGENERATED BY ECOSCOPE-WORKFLOWS; see fingerprint in README.md for details


FROM bitnami/minideb:bullseye AS fetch
RUN apt-get update && apt-get install -y curl ca-certificates
RUN curl -fsSL https://pixi.sh/install.sh | PIXI_VERSION=latest bash

FROM bitnami/minideb:bullseye AS install
COPY --from=fetch /root/.pixi /root/.pixi
COPY --from=fetch /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt
ENV PATH="/root/.pixi/bin:$PATH"

# if local release artifacts are required by the spec, then we expect them to
# have been copied into the build context at .tmp, and we copy them into the
# container here, to the aboslute path /tmp, for compatibility with the pixi
# requirement that local release artifacts reside within an absolute path.
COPY .tmp /tmp
RUN rm -rf .tmp

WORKDIR /app
COPY . .
RUN pixi install -e default -e runner --locked

FROM install AS app
ENV PORT 8080
ENV CONCURRENCY 1
ENV UVICORN_TIMEOUT 600
CMD ECOSCOPE_WORKFLOWS_MATCHSPEC_OVERRIDE=ecoscope-workflows-hydrological-monitoring-workflow \
    pixi run -e runner \
    uvicorn --host 0.0.0.0 --port $PORT --workers $CONCURRENCY --timeout-graceful-shutdown $UVICORN_TIMEOUT ecoscope_workflows_runner.app:app
